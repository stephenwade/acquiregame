<link rel="import" href="tile-view.html">
<link rel="import" href="fs-button.html">
<link rel="import" href="../../acquire-stepper/acquire-stepper.html">
<link rel="import" href="./chain-choice-tile.html">

<template id="playerView">
  <style>
    tile-view {
      height: 13vw;
      width: 13vw;
      
      font-size: 4vw;
      background-color: gray;
    }
    
    #turnState {
      position: absolute;
      bottom: 0;
      
      width: 100%;
      
      margin-left: auto;
      margin-right: auto;
      
      background-color: #555555;
      
      color: #ffffff;
      text-align: center;
      
      transition: ease 1s;
    }
    
    :host {
      box-sizing: border-box;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: Roboto;
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }
    #info {
      flex-grow: 1;
      display: flex;
    }
    #stocks table {
      line-height: 1.3;
    }
    #stocks table td {
      padding: 0 0.5em;
    }
    #stocks,
    #money {
      padding: 1em;
      width: 34vw;
      border-right: 2px solid black;
    }
    #money-value {
      font-size: 2em;
    }
    #other {
      display: flex;
      flex-direction: column;
      width: 32vw;
    }
    #other > * {
      flex-grow: 1;
      padding: 1em;
    }
    #end-game {
      border-bottom: 1px solid black;
    }
    #turn-state {
      border-top: 1px solid black;
    }
    #tiles {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      
      height: calc(13vw + 2em);
      padding: 1em 1em 1em 1em;
      border-top: 2px solid black;
    }
    h3 {
      margin-top: 0;
    }
    .modal {
      display: none;
      background-color: rgba(0, 0, 0, 0.54);
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
    .modal.visible {
      display: block;
    }
    .modal-container {
      position: absolute;
      top: 2em;
      right: 4em;
      bottom: 2em;
      left: 4em;
      padding: 1em;
      background-color: white;
      box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                  0 1px 10px 0 rgba(0, 0, 0, 0.12),
                  0 2px 4px -1px rgba(0, 0, 0, 0.4); /* from paper-styles */
    }
    .tower {
      background-color: #FFFA7A;
    }
    .luxor {
      background-color: #FFA042;
    }
    .american {
      background-color: #6B65FF;
    }
    .worldwide {
      background-color: #A78966;
    }
    .festival {
      background-color: #1CC424;
    }
    .imperial {
      background-color: #FF285A;
    }
    .continental {
      background-color: #28FFCD;
    }
    #stock-tiles {
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      align-items: flex-start;
      position: absolute;
      top: 4em;
      bottom: 3em;
      left: 1em;
    }
    .stock-tile {
      display: none;
      padding: 0.2em 0.5em;
      margin: 0 1em 1em 0;
    }
    .stock-tile.available {
      display: inline-block;
    }
    .stock-tile-name {
      display: inline-block;
      width: 6em;
    }
    #stock-modal-error {
      color: red;
    }
    #stock-modal-buttons {
      position: absolute;
      right: 1em;
      bottom: 1em;
    }
    .custom-button {
      display: inline-block;
      border-radius: 3px;
      cursor: pointer;
      padding: 0.5em 1em;
      text-transform: uppercase;
      margin-left: 0.5em;
    }
    .custom-button[raised] {
      background: blue;
      color: white;
    }
    fs-button {
      position: absolute;
      top: 1em;
      right: 1em;
    }
  </style>
  
  <div id="info">
    <div id="stocks">
      <h3>Stocks</h3>
      <table>
        <thead>
          <tr><th>chain</th>      <th                       >#</th></tr>
        </thead>
        <tbody>
          <tr><td>Tower</td>      <td id="tower-count"      >0</td></tr>
          <tr><td>Luxor</td>      <td id="luxor-count"      >0</td></tr>
          <tr><td>American</td>   <td id="american-count"   >0</td></tr>
          <tr><td>Worldwide</td>  <td id="worldwide-count"  >0</td></tr>
          <tr><td>Festival</td>   <td id="festival-count"   >0</td></tr>
          <tr><td>Imperial</td>   <td id="imperial-count"   >0</td></tr>
          <tr><td>Continental</td><td id="continental-count">0</td></tr>
        </tbody>
      </table>
    </div>
    <div id="money">
      <h3>Money</h3>
      <div id="money-value">$6,000</div>
    </div>
    <div id="other">
      <div id="end-game"><h3>End the game</h3></div>
      <div id="turn-state"><h3 id="turn-state-text">Waitingâ€¦</h3></div>
    </div>
  </div>
  <div id="tiles">
    <tile-view></tile-view>
    <tile-view></tile-view>
    <tile-view></tile-view>
    <tile-view></tile-view>
    <tile-view></tile-view>
    <tile-view></tile-view>
  </div>
  <fs-button></fs-button>
  <div id="chain-modal" class="modal">
    <div id="chain-modal-container" class="modal-container">
      <h3>Choose a chain to create:</h3>
      <div id="chain-tiles">
        <chain-choice-tile chain="tower" class="tower"></chain-choice-tile>
        <chain-choice-tile chain="luxor" class="luxor"></chain-choice-tile>
        <chain-choice-tile chain="american" class="american"></chain-choice-tile>
        <chain-choice-tile chain="worldwide" class="worldwide"></chain-choice-tile>
        <chain-choice-tile chain="festival" class="festival"></chain-choice-tile>
        <chain-choice-tile chain="imperial" class="imperial"></chain-choice-tile>
        <chain-choice-tile chain="continental" class="continental"></chain-choice-tile>
      </div>
    </div>
  </div>
  <div id="stock-modal" class="modal">
    <div id="stock-modal-container" class="modal-container">
      <h3>The market is open!</h3>
      <div id="stock-tiles">
        <div id="tower-stock-tile" class="tower stock-tile">
          <span class="stock-tile-name">Tower</span>
          <acquire-stepper class="stock-tile-stepper" max="3" value="0"></acquire-stepper>
        </div>
        <div id="luxor-stock-tile" class="luxor stock-tile">
          <span class="stock-tile-name">Luxor</span>
          <acquire-stepper class="stock-tile-stepper" max="3" value="0"></acquire-stepper>
        </div>
        <div id="american-stock-tile" class="american stock-tile">
          <span class="stock-tile-name">American</span>
          <acquire-stepper class="stock-tile-stepper" max="3" value="0"></acquire-stepper>
        </div>
        <div id="worldwide-stock-tile" class="worldwide stock-tile">
          <span class="stock-tile-name">Worldwide</span>
          <acquire-stepper class="stock-tile-stepper" max="3" value="0"></acquire-stepper>
        </div>
        <div id="festival-stock-tile" class="festival stock-tile">
          <span class="stock-tile-name">Festival</span>
          <acquire-stepper class="stock-tile-stepper" max="3" value="0"></acquire-stepper>
        </div>
        <div id="imperial-stock-tile" class="imperial stock-tile">
          <span class="stock-tile-name">Imperial</span>
          <acquire-stepper class="stock-tile-stepper" max="3" value="0"></acquire-stepper>
        </div>
        <div id="continental-stock-tile" class="continental stock-tile">
          <span class="stock-tile-name">Continental</span>
          <acquire-stepper class="stock-tile-stepper" max="3" value="0"></acquire-stepper>
        </div>
      </div>
      <div id="stock-modal-buttons">
        <span id="stock-modal-error"></span>
        <span id="stock-button-cancel" class="custom-button">Not yet</span>
        <span id="stock-button-confirm" class="custom-button" raised>Purchase</span>
      </div>
    </div>
  </div>
</template>

<script src="./player.js"></script>
<script>
  'use strict';
  
  HTMLCollection.prototype[Symbol.iterator] = Array.prototype[Symbol.iterator];
  NodeList.prototype[Symbol.iterator] = Array.prototype[Symbol.iterator];
  
  (() => {
    let template = document.currentScript.ownerDocument.querySelector('#playerView');
    let prototype = Object.create(HTMLElement.prototype);
    
    Object.assign(prototype, {
      createdCallback() {
        this.root = this.createShadowRoot();
        this.root.appendChild(document.importNode(template.content, true));
        
        this.player = new Player();
        
        this.fullscreen = false;
        
        let views = this.root.querySelectorAll('tile-view');
        for (let tileView of views) {
          tileView.setPlayer(this.player);
        }
        
        this.colors = {
          towerPrimary:       '#FFFA7A',
          towerAccent:        '#FFDA47',
          luxorPrimary:       '#FFA042',
          luxorAccent:        '#F3871B',
          americanPrimary:    '#6B65FF',
          americanAccent:     '#3E39D5',
          worldwidePrimary:   '#A78966',
          worldwideAccent:    '#7B5F41',
          festivalPrimary:    '#1CC424',
          festivalAccent:     '#15971C',
          imperialPrimary:    '#FF285A',
          imperialAccent:     '#C1002D',
          continentalPrimary: '#28FFCD',
          continentalAccent:  '#00C194',
          unclaimed:          '#555555'
        }
      },
      
      attachedCallback() {
        var self = this;
        
        this.addClickListener('#turn-state',            ()  => self.turnStateClick() );
        this.addClickListener('#chain-modal',           ()  => self.chainModalDismiss() );
        this.addClickListener('#chain-modal-container', (e) => e.stopPropagation() );
        let views = this.root.querySelectorAll('chain-choice-tile');
        for (let chainView of views) {
          chainView.addEventListener('click', () => self.chainSubmit(chainView.chain));
        }
        this.addClickListener('#stock-modal',           ()  => self.stockModalDismiss() );
        this.addClickListener('#stock-modal-container', (e) => e.stopPropagation() );
        this.addClickListener('#stock-button-cancel',   ()  => self.stockModalDismiss());
        this.addClickListener('#stock-button-confirm',  ()  => self.stockModalSubmit());
        
        // Events
        socket.on('new tiles', (tiles) => self.addTiles(tiles) );
        socket.on('new shares', (shares) => self.updateShares(shares) );
        
        // States
        socket.on('play a tile', (tiles) => {
          self.player.chooseTile();
          self.displayTurnStatus();
        });
        socket.socket.on('tile played', (tile) => self.checkTiles(tile) );
        socket.on('create a chain', (chains) => self.createChain(chains) );
        socket.on('buy stocks', (stocks) => self.buyStock(stocks) );
      },
      
      detachedCallback() {
      },
      
      addClickListener(element, callback) {
        this.root.querySelector(element).addEventListener('click', callback);
      },
      
      turnStateClick() {
        var self = this;
        
        switch (this.player.state) {
          case 'create chain':
            this.root.querySelector('#chain-modal').classList.add('visible');
            let chainTiles = this.root.querySelectorAll('chain-choice-tile');
            console.log(self.player.stateData);
            Array.prototype.filter.call(chainTiles, (tile) => {
              console.log('filtering', tile, tile.chain);
              
              return self.player.stateData.indexOf(tile.chain) !== -1;
            }).forEach( (tile) => {
              tile.classList.add('available');
            });
            break;
          case 'buy stock':
          // default:
            this.root.querySelector('#stock-modal').classList.add('visible');
            let stockTiles = this.root.querySelectorAll('.stock-tile');
            
            for (let tile of stockTiles) {
              for (let stock of this.player.stateData) {
                if (tile.id.replace(/-stock-tile/, '') == stock.chain) {
                  let stepper = tile.querySelector('acquire-stepper');
                  stepper.value = 0;
                  stepper.max = Math.min(3, stock.count);
                  tile.classList.add('available');
                }
              }
            }
            break;
        }
      },
      
      chainModalDismiss() {
        this.root.querySelector('#chain-modal').classList.remove('visible');
        let chainTiles = this.root.querySelectorAll('chain-choice-tile');
        for (let tile of chainTiles) {
          tile.classList.remove('available');
        }
      },
      
      stockModalDismiss() {
        this.root.querySelector('#stock-modal').classList.remove('visible');
        let stockTiles = this.root.querySelectorAll('.stock-tile');
        for (let tile of stockTiles) {
          tile.classList.remove('available');
        }
      },
      
      stockModalSubmit() {
        let stockTiles = this.root.querySelectorAll('.stock-tile.available');
        let purchases = [];
        for (let tile of stockTiles) {
          let stepper = tile.querySelector('acquire-stepper');
          console.log('tile', tile, 'stepper', stepper);
          purchases.push({
            chain: tile.id.replace(/-stock-tile/, ''),
            count: stepper.value
          });
        }
        let sum = 0;
        for (let chain of purchases)
          sum += chain.count;
        if (sum > 3) {
          this.root.querySelector('stock-modal-error').innerText =
            'You can only buy up to 3 total shares.';
        } else {
          console.log(purchases);
          socket.emit('stocks purchased', purchases);
          this.root.querySelector('#stock-modal').classList.remove('visible');
        }
      },
      
      chainSubmit(chain) {
        socket.emit('chain chosen', chain);
        this.chainModalDismiss();
        this.player.state = 'waiting';
        this.player.stateData = undefined;
        this.displayTurnStatus();
      },
      
      addTiles(tiles) {
        let views = this.root.querySelectorAll('tile-view');
        
        for (let tile of tiles) {
          this.player.hand.push(tile);
          
          for (let tileView of views) {
            if (tileView.isEmpty()) {
              tileView.setTile(tile);
              break;
            }
          }
        }
      },
      
      updateShares(shares) {
        console.log('new shares!', shares);
        this.player.addShares(shares.chain, shares.quantity);
        
        let id = '#' + shares.chain + '-count';
        this.root.querySelector(id).innerText = this.player.portfolio[shares.chain];
      },
      
      checkTiles(tile) {
        let tileViews = this.root.querySelectorAll('tile-view');
        
        if (this.player.choosingTile()) {
          this.player.tileChosen();
          this.displayTurnStatus();
        }
      },
      
      createChain(chains) {
        this.player.state = 'create chain';
        this.player.stateData = chains;
        this.displayTurnStatus();
      },
      
      buyStock(stocks) {
        this.player.state = 'buy stock';
        this.player.stateData = stocks;
        console.log(stocks);
        this.displayTurnStatus();
      },
      
      displayTurnStatus() {
        console.log('displaying!');
        let stateView = this.root.querySelector('#turn-state-text');
        
        let message = {
          'waiting':       'Waiting...',
          'choosing tile': 'Click to choose a tile',
          'create chain':  'Click to choose a chain',
          'buy stock':     'Click to buy stock'
        }[this.player.state];
        
        stateView.innerText = message ? message : 'State unknown';
      },
      
      toggleFullScreen() {
        let doc = document.documentElement;
        
        this.fullscreen ? document.webkitExitFullscreen() : doc.webkitRequestFullscreen();
        this.fullscreen = ! this.fullscreen;
      }
    });
    
    window.PlayerPage = document.registerElement('player-page', { prototype });
  })();
</script>
